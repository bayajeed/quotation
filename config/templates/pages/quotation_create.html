{% extends 'base.html' %}
{% block title %}Create Quotation{% endblock %}
{% block content %}
<h3>Create Quotation</h3>
<head>
  <title>Create Quotation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">
<h3>Create Quotation</h3>

<form method="POST" id="quotationForm">
  {% csrf_token %}
  <div class="row mb-3">
    <div class="col"><input name="title" class="form-control" placeholder="Title"></div>
    <div class="col"><input name="client" class="form-control" placeholder="Client Name"></div>
    <div class="col">
      <select id="templateSelect" name="template" class="form-select">
        <option value="">--Select Template--</option>
        {% for t in templates %}
          <option value="{{ t.id }}">{{ t.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div id="groupContainer"></div>

  <button type="submit" class="btn btn-primary mt-3">Save & View</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$('#templateSelect').change(function(){
  let id = $(this).val();
  if(!id) return;
  $.get(`/load-template/${id}/`, function(data){
    $('#groupContainer').empty();
    $.each(data.groups, function(groupName, items){
      let html = `
      <h5 class="mt-3">${groupName}</h5>
      <input type="hidden" name="group_name[]" value="${groupName}">
      <table class="table table-bordered">
        <thead><tr><th>Description</th><th>Qty</th><th>Unit</th><th>Price</th><th>Total</th></tr></thead>
        <tbody>`;
      items.forEach(function(it){
        let total = (it.qty || 0) * (it.unit_price || 0);
        html += `<tr>
          <td><input name="description[]" class="form-control" value="${it.description}"></td>
          <td><input name="qty[]" class="form-control qty" value="${it.qty||''}"></td>
          <td><input name="unit[]" class="form-control" value="${it.unit||''}"></td>
          <td><input name="unit_price[]" class="form-control price" value="${it.unit_price}"></td>
          <td><input name="total_price[]" class="form-control total" readonly value="${total}"></td>
          <input type="hidden" name="group_name[]" value="">
        </tr>`;
      });
      html += `</tbody></table>`;
      $('#groupContainer').append(html);
    });
  });
});

$(document).on('input', '.qty, .price', function(){
  let row = $(this).closest('tr');
  let qty = parseFloat(row.find('.qty').val()) || 0;
  let price = parseFloat(row.find('.price').val()) || 0;
  row.find('.total').val(qty * price);
});
</script>
</body>

{% endblock %}
