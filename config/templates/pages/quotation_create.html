{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h3>üßæ ‡¶®‡¶§‡ßÅ‡¶® Quotation ‡¶§‡ßà‡¶∞‡¶ø</h3>
    <form method="POST" id="quotationForm">
        {% csrf_token %}
        
        <div class="mb-3">
            <label>Quotation Title:</label>
            <input type="text" name="title" class="form-control" required>
        </div>

        <div class="mb-3">
            <label>Client Name:</label>
            <input type="text" name="client" class="form-control">
        </div>

        <div class="mb-3">
            <label>Select Template:</label>
            <select name="template" id="templateSelect" class="form-control">
                <option value="">-- Choose Template --</option>
                {% for t in templates %}
                <option value="{{ t.id }}">{{ t.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="itemContainer">
            <!-- Groups and items will be loaded dynamically here -->
        </div>

        <button type="button" class="btn btn-sm btn-success" id="addGroupBtn">‚ûï Add New Group</button>

        <hr>
        <button type="submit" class="btn btn-primary">üíæ Save Quotation</button>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const templateSelect = document.getElementById("templateSelect");
    const itemContainer = document.getElementById("itemContainer");
    const addGroupBtn = document.getElementById("addGroupBtn");

    // Template change ‡¶ï‡¶∞‡¶≤‡ßá AJAX call ‡¶π‡¶¨‡ßá
    templateSelect.addEventListener("change", function () {
        const templateId = this.value;
        if (!templateId) return;

        fetch(`/load-template-items/${templateId}/`)
            .then(res => res.json())
            .then(data => {
                itemContainer.innerHTML = "";
                for (const [group, items] of Object.entries(data.groups)) {
                    addGroup(group, items);
                }
            });
    });

    // Add group manually
    addGroupBtn.addEventListener("click", () => addGroup(""));

    function addGroup(groupName = "", items = []) {
        const groupDiv = document.createElement("div");
        groupDiv.classList.add("border", "p-3", "mb-3", "rounded");
        groupDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <input type="text" name="group_name[]" class="form-control form-control-sm w-50" placeholder="Group Name" value="${groupName}">
                <button type="button" class="btn btn-danger btn-sm remove-group">‚ùå</button>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Description</th><th>Qty</th><th>Unit</th><th>Unit Price</th><th>Total</th><th></th>
                    </tr>
                </thead>
                <tbody class="item-body"></tbody>
            </table>
            <button type="button" class="btn btn-sm btn-outline-primary add-item">‚ûï Add Item</button>
        `;
        itemContainer.appendChild(groupDiv);

        const itemBody = groupDiv.querySelector(".item-body");
        const addItemBtn = groupDiv.querySelector(".add-item");

        // Load existing items (if template loaded)
        items.forEach(it => addItem(itemBody, it.description, it.qty, it.unit, it.unit_price));

        // Add new item manually
        addItemBtn.addEventListener("click", () => addItem(itemBody));

        // Remove group
        groupDiv.querySelector(".remove-group").addEventListener("click", () => groupDiv.remove());
    }

    function addItem(itemBody, desc = "", qty = "", unit = "", price = "") {
        const row = document.createElement("tr");
        const total = price && qty ? (parseFloat(price) * parseFloat(qty)).toFixed(2) : "";
        row.innerHTML = `
            <td><input type="text" name="description[]" class="form-control form-control-sm" value="${desc}"></td>
            <td><input type="number" name="qty[]" class="form-control form-control-sm qty" value="${qty}"></td>
            <td><input type="text" name="unit[]" class="form-control form-control-sm" value="${unit}"></td>
            <td><input type="number" name="unit_price[]" class="form-control form-control-sm unit_price" value="${price}"></td>
            <td><input type="number" name="total_price[]" class="form-control form-control-sm total" value="${total}" readonly></td>
            <td><button type="button" class="btn btn-sm btn-danger remove-item">üóë</button></td>
        `;
        itemBody.appendChild(row);

        // Auto calculate total
        row.querySelectorAll(".qty, .unit_price").forEach(inp => {
            inp.addEventListener("input", () => {
                const q = parseFloat(row.querySelector(".qty").value || 0);
                const p = parseFloat(row.querySelector(".unit_price").value || 0);
                row.querySelector(".total").value = (q * p).toFixed(2);
            });
        });

        row.querySelector(".remove-item").addEventListener("click", () => row.remove());
    }
});
</script>
{% endblock %}
